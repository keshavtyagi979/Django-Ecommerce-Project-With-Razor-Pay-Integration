{% extends 'store/main.html' %}
{% load static %}
{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="box-element" id="form-wrapper">
            <form id="form">
                
                <div id="user-info">
                    <div class="form-field">
                        <input required class="form-control" type="text" name="name" placeholder="Name..">
                    </div>
                    <div class="form-field">
                        <input required class="form-control" type="email" name="email" placeholder="Email..">
                    </div>
                </div>
                
                
                <div id="shipping-info">
                    <hr>
                    <p>Shipping Information:</p>
                    <hr>
                    <div class="form-field">
                        <input class="form-control" type="text" name="address" placeholder="Address..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="city" placeholder="City..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="state" placeholder="State..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="zipcode" placeholder="Zip code..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="country" placeholder="Country..">
                    </div>
                </div>

                <hr>
                
                <p>Have a Coupon?</p>
                <div class="form-field d-flex">
                    <input class="form-control" type="text" id="coupon-code" placeholder="Enter coupon code">
                    <button type="button" id="apply-coupon" class="btn btn-outline-primary ml-2">Apply</button>
                </div>
                <small id="coupon-message" style="color:green; display:none;"></small>
                <hr>

                <input id="form-button" class="btn btn-success btn-block" type="submit" value="Continue">
            </form>
        </div>

        
        <br>
        <div class="box-element hidden" id="payment-info">
            <small>Payment Options</small>
            <button id="rzp-button1" class="btn btn-primary btn-block">Pay with Razorpay</button>
        </div>
    </div>

    
    <div class="col-lg-6">
        <div class="box-element">
            <a class="btn btn-outline-dark" href="{% url 'store:cart' %}">&#x2190; Back to Cart</a>
            <hr>
            <h3>Order Summary</h3>
            <hr>
            {% for item in items %}
            <div class="cart-row">
                <div style="flex:2"><img class="row-image" src="{{item.product.imageURL}}"></div>
                <div style="flex:2"><p>{{item.product.name}}</p></div>
                <div style="flex:1"><p>₹{{item.product.price|floatformat:2}}</p></div>
                <div style="flex:1"><p>x{{item.quantity}}</p></div>
            </div>
            {% endfor %}
            <h5>Items: {{order.get_cart_items}}</h5>
            <h5 id="total-amount">Total: ₹{{order.get_cart_total|floatformat:2}}</h5>
            <h5 id="discounted-amount" style="display:none; color:green;"></h5>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const csrftoken = getCookie('csrftoken');
    const shipping = '{{order.shipping}}' === 'True';
    let total = parseFloat('{{order.get_cart_total|floatformat:2}}');
    const user = '{{request.user}}';

    const formWrapper = document.getElementById('form-wrapper');
    const paymentInfo = document.getElementById('payment-info');
    const userInfo = document.getElementById('user-info');
    const shippingInfo = document.getElementById('shipping-info');

    function showPaymentSection() {
        formWrapper.classList.add("hidden");
        paymentInfo.classList.remove("hidden");
    }

    if (!shipping) shippingInfo.style.display = "none";
    if (user !== 'AnonymousUser') userInfo.style.display = "none";

    let rzp1 = new Razorpay({
        "key": "{{ razorpay_merchant_key }}",
        "amount": parseInt({{ razorpay_amount }}),
        "currency": "{{ currency }}",
        "name": "Tyagi Corp",
        "description": "Purchase",
        "order_id": "{{ razorpay_order_id }}",
        "handler": function(response){
            fetch("{{ callback_url }}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    "razorpay_payment_id": response.razorpay_payment_id,
                    "razorpay_order_id": response.razorpay_order_id,
                    "razorpay_signature": response.razorpay_signature,
                    "razorpay_amount": parseInt(total * 100)
                })
            }).then(res => res.text())
              .then(data => {
                  if(data.includes("success")) window.location.href = "/paymentsuccess/";
                  else window.location.href = "/paymentfail/";
              }).catch(err => window.location.href = "/paymentfail/");
        }
    });

    if (!shipping && user !== 'AnonymousUser') {
        showPaymentSection();
    }

    document.getElementById('form-button').addEventListener('click', function(e){
        e.preventDefault();
        let formData = { form: {}, shipping: {} };

        if (user === 'AnonymousUser') {
            formData.form.name = userInfo.querySelector('input[name="name"]').value;
            formData.form.email = userInfo.querySelector('input[name="email"]').value;
        }

        if (shipping) {
            shippingInfo.querySelectorAll('input').forEach(input => {
                formData.shipping[input.name] = input.value;
            });
        }

        formData.form.total = total;

        fetch("{% url 'store:process_order' %}", {
            method: "POST",
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(formData)
        }).then(res => res.json())
          .then(data => { showPaymentSection(); })
          .catch(err => console.error(err));
    });

    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    }

    document.getElementById("apply-coupon").addEventListener("click", function(){
        let code = document.getElementById("coupon-code").value.trim();
        if(code === ""){ alert("Please enter a coupon code."); return; }

        fetch("{% url 'store:apply_coupon' %}", {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/json" },
            body: JSON.stringify({ "code": code })
        })
        .then(async res => {
            if(!res.ok){ const text = await res.text(); throw new Error(text || "HTTP error"); }
            return res.json();
        })
        .then(data => {
            if(data.valid){
                let discounted = parseFloat(data.new_total).toFixed(2);
                document.getElementById("total-amount").style.textDecoration = "line-through";
                document.getElementById("total-amount").style.color = "red";
                document.getElementById("discounted-amount").innerText = "Discounted Total: ₹" + discounted;
                document.getElementById("discounted-amount").style.display = "block";
                document.getElementById("discounted-amount").style.color = "green";
                document.getElementById("discounted-amount").style.fontWeight = "bold";
                document.getElementById("coupon-message").innerText = "Coupon applied! Discount: " + data.discount + "%";
                document.getElementById("coupon-message").style.color = "green";
                document.getElementById("coupon-message").style.display = "block";

                total = parseFloat(discounted);

                rzp1 = new Razorpay({
                    "key": "{{ razorpay_merchant_key }}",
                    "amount": parseInt(data.razorpay_amount),
                    "currency": "{{ currency }}",
                    "name": "Tyagi Corp",
                    "description": "Purchase",
                    "order_id": data.razorpay_order_id,
                    "handler": rzp1.options.handler
                });
            } else {
                document.getElementById("coupon-message").innerText = "Invalid or expired coupon.";
                document.getElementById("coupon-message").style.color = "red";
                document.getElementById("coupon-message").style.display = "block";
            }
        })
        .catch(err => { console.error("Coupon error:", err); });
    });
});
</script>
{% endblock %}
